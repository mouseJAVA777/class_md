## 네트워크 기초 06 

###### 멀리 있는 컴퓨터끼리는 이렇게 데이터를 주고 받는다.

###### <br/>

### 🎀 IPv4 프로토콜

#### IPv4가 하는 일

> 네트워크 상에서 데이터를 교환하기 위한 프로토콜
>
> 데이터가 **정확하게 전달될 것을 보장 X**
>
> 중복된 패킷을 전달하거나 패킷의 순서를 잘못 전달할 가능성도 있음.
>
> (악의적으로 이용되면  DoS 공격이 됨.)
>
> 데이터의 정확하고 순차적인 전달은 그보다 상위 프로토콜인 **TCP**에서 보장
>
> **→ 신뢰있는 전달은 4계층, 3계층은 그냥 멀리 있는 곳으로 전달하는 역할**

#### IPv4 프로토콜의 구조

- 1 줄: 4 byte

- 기본은 5줄 (20byte), 옵션이 붙으면 4 byte씩 추가

- **상세 구조**

  - **마지막 두 줄: 출발지 + 목적지 주소**

  - **Version**: 무조건 4가 온다고 생각하면 됨. (IPv6는 구조가 아예 달라서 오는 경우가 없음)

  - **IHL (Header Length):** 헤더의 길이 *(**실제 길이/4**, 5+옵션 개수)*

  - **Type of Service (TOS):** 지금은 사용되지 않음 → 0

  - **Total Length:** payload까지 합친 전체 길이

  - **Identification, IP Flags, Fragment Offset**

    - 데이터를 보낼 때 최대 전송 길이 제한이 있기 때문에, 잘게 잘게 잘라서 보내는데, 이 것을 알아보기 위해 사용되는 값들 세트.

    - **Identification**: 하나의 전체 데이터를 쪼갰을 때, 하나의 데이터라는 것을 알아보기 위해서 동일한 아이디를 가지는데, 그 아이디

    - **IP Flags**

      - 3 비트

      - **D (2 번째):** 패킷의 쪼갬 유무 

        (근데 쪼개면 전송이 안되므로 거의 안씀)

      - **M (3 번째):** 뒤에 다른 패킷이 있으므로 기다려야 한다는 것을 의미 

        (조각화가 되면 1, 아니면 0)

    - **Fragment Offset:** 조각들의 순서

      (시작으로부터 얼마만큼 떨어져 있는지, 0~)

    - **Time To Live (TTL)**
      - 얼마나 오랫동안 살아있는지
      - 라우터를 통과할 때마다 -1
      - 0이 되면 사라짐
    - **Protocol:** 상위 프로토콜의 타입
    - **Header Checksum:** 오류가 발생했는지 확인하기 위한 값

<br/>

### 🛒 ICMP 프로토콜

###### (Internet Control Message Protocol, 인터넷 제어 메시지 프로토콜)

#### ICMP가 하는 일

- 상대방과의 통신이 되는지 확인하기 위해 사용됨.

>네트워크 컴퓨터 위에서 돌아가는 운영체제에서 **오류 메시지**를 전송 받는 데 주로 쓰임.
>
>프로토콜 구조의 Type과 Code를 통해 오류 메시지를 전송 받음

#### ICMP 프로토콜의 구조

- **Type**: 대분류

  - 0,8,3,11,8 번은 알아둬야 함.
    - 0: 응답
    - 8: 요청 (통신 유무를 확인하기 위해 상대방에게 요청)
    - 3: 목적지에 도달 X (가능 경로 상에 문제, ex. 경로 설정 오류)
    - 11: 요청 시간 만료 (상대방이 문제, 목적지에는 갔지만 응답 X, ex. 상대방이 방화벽을 켰을 때)
    - 5: 원격지에 있는 상대방의 라우팅 테이블을 ICMP를 통해 수정하는 것 (보안상)어어어

  ![image](https://user-images.githubusercontent.com/88833439/188297708-82c8d43f-ac9c-4e78-a3bd-0f382b8bc9cd.png)

- Code: 소분류

- Checksum: 헤더에 오류가 있는지 확인하기 위한 값

<br/>

### 🎨 라우팅 테이블 및 전송 과정

- 3계층에서 사용 될 최적의 경로를 지도처럼 저장해놓을 것
- `netstat -r`로 확인
- 라우팅 테이블에 적혀있는 네트워크 대역만 찾아갈 수 있음.

#### 다른 네트워크와 통신하는 과정

- 이더넷의 목적지 주소는 가까운 곳에서 갈 수 있는 목적지 주소

  (아래 그림 상에서는 cc:cc:cc:cc:cc:cc)

- 이더넷은 네트워크 프로토콜이 바뀔 때마다 새롭게 작성.

![image](https://user-images.githubusercontent.com/88833439/188298264-2eae7408-4a3d-4b30-98d9-a931e9a2323c.png)

##### ✨ A에서 B로 통신하는 상세한 과정 ✨

1. A에서 B로 통신을 하려고 함.

   - A의 라우팅 테이블 확인

     - B의 네트워크 대역이 본인 라우팅 테이블에 있어야지 통신 가능.
     - 확인 후 `192.168.10.1`로 감.
     - ICMP 요청, IPv4, Ethernet 순으로 프로토콜 작성

     - 이더넷 프로토콜의 목적지는 게이트웨이의 mac 주소가 작성됨.

   ![image](https://user-images.githubusercontent.com/88833439/188298551-f84d58ea-3ac8-4ec8-b47a-de34e358b070.png)

2. 패킷을 스위치에 보냄

   - 2계층까지만 확인하고, C에게 보냄

3. C가 패킷 받음

   - 2계층(Ethernet) 확인 (자신에게 온 것을 확인)

   - 3계층(IPv4) 확인 (목적지 IP가 자신이 아닌 것을 확인)

   - C의 라우팅 테이블 확인

     - 20번 대역은 `192.168.30.2`로 가야한다는 것을 확인
     - 이더넷 프로토콜 다시 작성

     ![image](https://user-images.githubusercontent.com/88833439/188298626-8835407c-149f-46a4-869a-05349ea7d0c6.png)

4. 위의 과정 반복

5. B가 통신을 전달 받음.

   - ICMP 요청이 온 것(8번)을 확인 받음.

     ![image](https://user-images.githubusercontent.com/88833439/188298915-9d54310b-31e8-4e4a-9525-b8adbdcd62c4.png)

   - ICMP 응답 (0번) 함.

     ![image](https://user-images.githubusercontent.com/88833439/188298959-90f7b9f1-ab84-4b60-bb55-f8be31d224e6.png)



- 위의 과정에서 ping 명령은 4번
- 부가적으로 상대의 mac 주소를 모르면 **arp 요청**도 해야 함.

<br/>

### 🎊 IPv4의 조각화

#### 조각화란?

> 큰 IP 패킷들이 적은 MTU(Maximum Transmission Unit)를 갖는 링크를 통하여 전송되려면 여러 개의 작은 패킷으로 쪼개어/조각화 되어 전송돼야 함.
>
> 즉, 목적지까지 패킷을 전달하는 과정에 통과하는 각 라우터마다 전송에 적합한 프레임으로 변환이 필요함.
>
> 일단 조각화되면, 최종 목적지에 도달할 때까지 재조립되지 않는 것이 일반적.
>
> IPv4에서는 발신지 뿐만 아니라 중간 라우터에서도 IP 조각화가 가능
>
> IPv6에서는 IP 단편화가 발신지에서만 가능
>
> 재조립은 항상 최종 수신지에서만 가능

![image](https://user-images.githubusercontent.com/88833439/188299574-40756e1c-22a4-4379-9ec7-7f4444325275.png)

- Header가 보통 20bytes이므로, 위 그림 상(MTU: 3300-Byte)에서 순수 데이터는 3280 bytes.
- 마지막 패킷을 제외한 패킷들의 **MF**는 1, 마지막 패킷은 0

- **Offset**은 8로 나눠서 사용함. (ex. 3280 bytes-> 410)

![image](https://user-images.githubusercontent.com/88833439/188299765-5ba8e11b-18d7-4199-9359-781af5e5f399.png)